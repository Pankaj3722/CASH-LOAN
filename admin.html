<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LOAN PAY — Admin</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* small overrides for admin */
    body{background:#f4f7fb}
    .admin-wrap{max-width:1000px;margin:18px auto;padding:18px}
    .tools{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #eef3ff;text-align:left;font-size:13px}
    th{background:linear-gradient(90deg,#f8fbff,#ffffff);font-weight:700}
    .smallmuted{color:#6b7280;font-size:13px}
    .danger{background:#ffefef;color:#a00}
    .ok{background:#e9fff2;color:#006a2e}
    .btn-sm{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  </style>
</head>
<body>
  <main class="admin-wrap">
    <h2>LOAN PAY — Admin Panel</h2>
    <p class="smallmuted">Yahan se aap local submissions dekh, export aur delete kar sakte hain.</p>

    <!-- optional simple auth -->
    <div id="authBox" class="card" style="margin-top:12px;">
      <label>Admin passcode (temporary):</label>
      <input id="adminPass" placeholder="Enter admin code" />
      <button id="authBtn" class="btn-sm">Unlock</button>
      <span class="smallmuted" style="margin-left:8px">Default code: <strong>1234</strong></span>
    </div>

    <div id="panel" style="display:none">
      <div class="tools">
        <button id="refreshBtn" class="btn-sm">Refresh</button>
        <button id="exportCsv" class="btn-sm">Export CSV</button>
        <button id="exportJson" class="btn-sm">Export JSON</button>
        <button id="downloadAll" class="btn-sm">Download All JSON</button>
        <button id="deleteAll" class="btn-sm danger">Delete All</button>
        <span id="count" class="smallmuted" style="margin-left:auto"></span>
      </div>

      <div style="overflow:auto">
        <table id="appsTable" role="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Submitted</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Amount</th>
              <th>Tenure</th>
              <th>Interest</th>
              <th>Purpose</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="appsBody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    // ADMIN PANEL JS (client-only)
    const STORAGE_KEY = 'loanpay_apps';
    const ADMIN_CODE = '1234'; // change if you want

    const authBox = document.getElementById('authBox');
    const authBtn = document.getElementById('authBtn');
    const adminPass = document.getElementById('adminPass');
    const panel = document.getElementById('panel');

    authBtn.onclick = () => {
      if (adminPass.value === ADMIN_CODE) {
        authBox.style.display = 'none';
        panel.style.display = '';
        loadApps();
      } else {
        alert('Wrong passcode');
      }
    };

    function loadApps() {
      const body = document.getElementById('appsBody');
      body.innerHTML = '';
      const raw = localStorage.getItem(STORAGE_KEY) || '[]';
      let apps = [];
      try { apps = JSON.parse(raw); } catch(e){ apps = []; }
      document.getElementById('count').innerText = apps.length + ' applications';
      apps.forEach((a, i) => {
        const tr = document.createElement('tr');
        const date = new Date(a.date || Date.now()).toLocaleString();
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${date}</td>
          <td>${escapeHtml(a.name||'')}</td>
          <td>${escapeHtml(a.email||'')}</td>
          <td>${escapeHtml(a.phone||'')}</td>
          <td>₹ ${a.amount||0}</td>
          <td>${a.tenure||''}</td>
          <td>${a.interest||''}%</td>
          <td>${escapeHtml(a.purpose||'')}</td>
          <td>
            <button onclick="downloadItem(${i})" class="btn-sm">Download</button>
            <button onclick="deleteItem(${i})" class="btn-sm danger">Delete</button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // exports
    function toCSV(arr){
      if(!arr || !arr.length) return '';
      const keys = ['date','name','email','phone','amount','tenure','interest','purpose'];
      const header = ['date','name','email','phone','amount','tenure','interest','purpose'];
      const rows = arr.map(obj => keys.map(k => `"${String(obj[k]||'').replace(/"/g,'""')}"`).join(','));
      return header.join(',') + '\\n' + rows.join('\\n');
    }

    function download(filename, text) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type: 'text/plain'}));
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    document.getElementById('refreshBtn').onclick = loadApps;
    document.getElementById('exportCsv').onclick = () => {
      const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const csv = toCSV(arr);
      if(!csv) return alert('No applications to export');
      download('loanpay_apps.csv', csv);
    };
    document.getElementById('exportJson').onclick = () => {
      const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      download('loanpay_apps.json', JSON.stringify(arr, null, 2));
    };
    document.getElementById('downloadAll').onclick = () => {
      const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      download('loanpay_all_'+Date.now()+'.json', JSON.stringify(arr, null, 2));
    };
    document.getElementById('deleteAll').onclick = () => {
      if(!confirm('Delete ALL local applications? This cannot be undone.')) return;
      localStorage.removeItem(STORAGE_KEY);
      loadApps();
      alert('All local applications deleted');
    };

    window.deleteItem = function(i){
      const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      if(!arr[i]) return;
      if(!confirm('Delete this application?')) return;
      arr.splice(i,1);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      loadApps();
    };

    window.downloadItem = function(i){
      const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      if(!arr[i]) return alert('Item not found');
      download('app_'+(i+1)+'.json', JSON.stringify(arr[i], null, 2));
    };

    // auto-load only after auth
    // (optional: auto-unlock if no admin code wanted)
    if (localStorage.getItem('loanpay_admin_unlocked') === '1') {
      authBox.style.display = 'none';
      panel.style.display = '';
      loadApps();
    }
  </script>
</body>
</html>
